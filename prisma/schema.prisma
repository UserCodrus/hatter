// schema.prisma

generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url = env("POSTGRES_PRISMA_URL") // uses connection pooling
	directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model Alias {
	id			String		@id @default(cuid())
	users		UserAlias[]
	creator		User?		@relation(fields: [creatorID], references: [id])
	creatorID	String?
	created		DateTime	@default(now())

	tag			String		@unique
	name		String
	bio			String?

	icon		String
	colorA		String
	colorB		String
	style		String

	posts		Post[]
	likes		Like[]
	following	Alias[]		@relation(name: "follow")
	followers	Alias[]		@relation(name: "follow")
}

model UserAlias {
	id			String		@id @default(cuid())
	user		User		@relation(fields: [userID], references: [id])
	userID		String		@unique
	alias		Alias?		@relation(fields: [aliasID], references: [id])
	aliasID		String?
	expires		DateTime	@default(now())
}

model Post {
	id			String		@id @default(cuid())
	index		Int			@unique @default(autoincrement())
	title		String?
	content		String?
	media		String?
	published	Boolean		@default(true)
	author		Alias		@relation(fields: [authorId], references: [id])
	authorId	String
	user		User?		@relation(fields: [userId], references: [id])
	userId		String?
	created		DateTime	@default(now())
	updated		DateTime	@default(now())

	reply		Post?		@relation(name: "reply", fields: [replyID], references: [id])
	replyID		String?
	replies		Post[]		@relation(name: "reply")
	likes		Like[]		@relation
}

model Like {
	time		DateTime	@default(now())
	post		Post		@relation(fields: [postID], references: [id])
	postID		String
	user		Alias		@relation(fields: [userID], references: [id])
	userID		String
	@@id([postID, userID])
}

model Permissions {
	id				String		@id
	user			User		@relation(fields: [id], references: [id])
	admin			Boolean		@default(false)
	moderator		Boolean		@default(false)
}

model User {
	id				String		@id @default(cuid())
	name			String?
	email			String?		@unique
	emailVerified	DateTime?
	ban				DateTime?
	image			String?
	alias			UserAlias?	@relation
	posts			Post[]
	ownedAliases	Alias[]
	accounts		Account[]
	sessions		Session[]
	permissions		Permissions?
	@@map(name: "users")
}

model Account {
	id					String		@id @default(cuid())
	userId				String  	@map("user_id")
	type				String
	provider			String
	providerAccountId	String  	@map("provider_account_id")
	refresh_token		String?
	access_token		String?
	expires_at			Int?
	token_type			String?
	scope				String?
	id_token			String?
	session_state		String?
	oauth_token_secret	String?
	oauth_token			String?

	user				User		@relation(fields:[userId], references:[id], onDelete: Cascade)

	@@unique([provider, providerAccountId])
}

model Session {
	id				String		@id @default(cuid())
	sessionToken	String		@unique @map("session_token")
	userId			String		@map("user_id")
	expires			DateTime
	user			User		@relation(fields:[userId], references:[id], onDelete: Cascade)
}

model VerificationToken {
	id			Int			@id @default(autoincrement())
	identifier	String
	token		String		@unique
	expires		DateTime

	@@unique([identifier, token])
}